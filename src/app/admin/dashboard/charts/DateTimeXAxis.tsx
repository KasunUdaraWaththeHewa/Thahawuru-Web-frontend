import React, { useEffect, useRef } from "react";
import ApexCharts from "apexcharts";

const DateTimeXAxis: React.FC = () => {
  const chartRef = useRef<HTMLDivElement>(null);

  useEffect(() => {
    if (!chartRef.current) return;

    const options = {
      series: [
        {
          data: [
            [1327359600000, 30.95],
            [1327446000000, 31.34],
            [1361919600000, 39.6],
            [1362006000000, 40.34],
            [1362092400000, 40.1],
            [1362351600000, 40.52],
            [1362438000000, 40.84],
            [1362524400000, 40.44],
            [1362783600000, 40.1],
            [1362870000000, 40.0],
            [1362956400000, 40.0],
            [1363042800000, 39.29],
            [1363302000000, 38.16],
            [1363388400000, 38.15],
            [1363474800000, 38.15],
            [1363561200000, 38.85],
            [1363820400000, 38.53],
            [1363906800000, 38.27],
            [1363993200000, 38.4],
            [1364079600000, 38.22],
            [1364338800000, 38.17],
            [1364425200000, 38.31],
            [1364511600000, 38.72],
            [1364598000000, 38.57],
            [1364684400000, 38.55],
            [1364943600000, 38.27],
            [1365030000000, 38.42],
            [1365116400000, 38.1],
            [1365202800000, 38.32],
            [1365289200000, 38.24],
            [1365548400000, 38.52],
            [1365634800000, 38.23],
            [1365721200000, 38.39],
            [1365807600000, 38.36],
            [1365894000000, 38.22],
            [1366153200000, 38.09],
            [1366239600000, 38.16],
            [1366326000000, 38.15],
            [1366412400000, 38.1],
            [1366498800000, 37.88],
            [1366758000000, 38.0],
            [1366844400000, 38.14],
            [1366930800000, 38.6],
            [1367017200000, 38.64],
            [1367103600000, 38.89],
            [1367362800000, 38.6],
            [1367449200000, 38.51],
            [1367535600000, 38.4],
            [1367622000000, 38.51],
            [1367708400000, 38.27],
            [1367967600000, 38.33],
            [1368054000000, 38.64],
            [1368140400000, 38.89],
            [1368226800000, 38.81],
            [1368313200000, 38.61],
            [1368572400000, 38.63],
            [1368658800000, 38.48],
            [1368745200000, 38.37],
            [1368831600000, 38.82],
            [1368918000000, 38.68],
            [1369177200000, 38.55],
            [1369263600000, 38.39],
            [1369350000000, 38.32],
            [1369436400000, 38.4],
            [1369522800000, 38.5],
            [1369782000000, 38.8],
            [1369868400000, 38.96],
            [1369954800000, 38.79],
            [1370041200000, 38.96],
            [1370300400000, 38.22],
            [1370386800000, 38.47],
            [1370473200000, 38.86],
            [1370559600000, 38.91],
            [1370646000000, 38.87],
            [1370905200000, 38.5],
            [1370991600000, 38.74],
            [1371078000000, 38.71],
            [1371164400000, 38.72],
            [1371250800000, 38.57],
            [1371510000000, 38.47],
            [1371596400000, 38.72],
            [1371682800000, 38.72],
            [1371769200000, 38.6],
            [1371855600000, 38.53],
            [1372114800000, 38.61],
            [1372201200000, 38.98],
            [1372287600000, 39.06],
            [1372374000000, 39.0],
            [1372460400000, 38.96],
            [1372719600000, 38.79],
            [1372806000000, 38.96],
            [1372892400000, 38.92],
            [1372978800000, 38.96],
            [1373065200000, 38.84],
            [1373324400000, 38.9],
            [1373410800000, 38.8],
            [1373497200000, 38.91],
            [1373583600000, 38.7],
            [1373670000000, 38.59],
            [1373929200000, 38.51],
            [1374015600000, 38.4],
            [1374102000000, 38.47],
            [1374188400000, 38.52],
            [1374274800000, 38.63],
            [1374534000000, 38.5],
            [1374620400000, 38.51],
            [1374706800000, 38.4],
            [1374793200000, 38.4],
            [1374879600000, 38.49],
            [1375138800000, 38.64],
            [1375225200000, 38.58],
            [1375311600000, 38.6],
            [1375398000000, 38.51],
            [1375484400000, 38.4],
            [1375743600000, 38.4],
            [1375830000000, 38.5],
            [1375916400000, 38.51],
            [1376002800000, 38.4],
            [1376089200000, 38.4],
            [1376348400000, 38.4],
            [1376434800000, 38.4],
            [1376521200000, 38.7],
            [1376607600000, 38.6],
            [1376694000000, 38.7],
            [1376953200000, 38.7],
            [1377039600000, 38.6],
            [1377126000000, 38.6],
            [1377212400000, 38.6],
            [1377298800000, 38.6],
            [1377558000000, 38.6],
            [1377644400000, 38.6],
            [1377730800000, 38.6],
            [1377817200000, 38.6],
            [1377903600000, 38.6],
            [1378162800000, 38.6],
            [1378249200000, 38.6],
            [1378335600000, 38.6],
            [1378422000000, 38.6],
            [1378508400000, 38.6],
            [1378767600000, 38.6],
            [1378854000000, 38.6],
            [1378940400000, 38.6],
            [1379026800000, 38.6],
            [1379113200000, 38.6],
            [1379372400000, 38.6],
            [1379458800000, 38.6],
            [1379545200000, 38.6],
            [1379631600000, 38.6],
            [1379718000000, 38.6],
            [1379977200000, 38.6],
            [1380063600000, 38.6],
            [1380150000000, 38.6],
            [1380236400000, 38.6],
            [1380322800000, 38.6],
            [1380582000000, 38.6],
            [1380668400000, 38.6],
            [1380754800000, 38.6],
            [1380841200000, 38.6],
            [1380927600000, 38.6],
            [1381186800000, 38.6],
            [1381273200000, 38.6],
            [1381359600000, 38.6],
            [1381446000000, 38.6],
            [1381532400000, 38.6],
            [1381791600000, 38.6],
            [1381878000000, 38.6],
            [1381964400000, 38.6],
            [1382050800000, 38.6],
            [1382137200000, 38.6],
            [1382396400000, 38.6],
            [1382482800000, 38.6],
            [1382569200000, 38.6],
            [1382655600000, 38.6],
            [1382742000000, 38.6],
            [1383001200000, 38.6],
            [1383087600000, 38.6],
            [1383174000000, 38.6],
            [1383260400000, 38.6],
            [1383346800000, 38.6],
            [1383606000000, 38.6],
            [1383692400000, 38.6],
            [1383778800000, 38.6],
            [1383865200000, 38.6],
            [1383951600000, 38.6],
            [1384210800000, 38.6],
            [1384297200000, 38.6],
            [1384383600000, 38.6],
            [1384470000000, 38.6],
            [1384556400000, 38.6],
            [1384815600000, 38.6],
            [1384902000000, 38.6],
            [1384988400000, 38.6],
            [1385074800000, 38.6],
            [1385161200000, 38.6],
            [1385420400000, 38.6],
            [1385506800000, 38.6],
            [1385593200000, 38.6],
            [1385679600000, 38.6],
            [1385766000000, 38.6],
          ],
        },
      ],
      chart: {
        id: "area-datetime",
        type: "area",
        height: 350,
        zoom: {
          autoScaleYaxis: true,
        },
      },
      annotations: {
        yaxis: [
          {
            y: 30,
            borderColor: "#ffffff",
            label: {
              show: true,
              text: "Support",
              style: {
                color: "#fff",
                background: "#023e8a",
              },
            },
          },
        ],
        xaxis: [
          {
            x: new Date("14 Nov 2012").getTime(),
            borderColor: "#999",
            yAxisIndex: 0,
            label: {
              show: true,
              text: "Rally",
              style: {
                color: "#fff",
                background: "#023e8a",
              },
            },
          },
        ],
      },
      dataLabels: {
        enabled: false,
      },
      markers: {
        size: 0,
        style: "hollow",
      },
      xaxis: {
        type: "datetime",
        min: new Date("01 Mar 2012").getTime(),
        tickAmount: 6,
        labels: {
          style: {
            colors: "#adb5bd",
          },
        },
      },
      tooltip: {
        x: {
          format: "dd MMM yyyy",
        },
      },
      fill: {
        type: "gradient",
        gradient: {
          shadeIntensity: 1,
          opacityFrom: 0.7,
          opacityTo: 0.9,
          stops: [0, 100],
        },
      },
      colors: ["#023e8a"],
    };

    const chart = new ApexCharts(chartRef.current, options);
    chart.render();

    const resetCssClasses = (activeEl: EventTarget | null) => {
      const els = document.querySelectorAll("button");
      els.forEach((el) => {
        el.classList.remove("active");
      });
      if (activeEl) {
        (activeEl as HTMLElement).classList.add("active");
      }
    };

    const zoomX = (startDate: Date, endDate: Date) => {
      chart.zoomX(startDate.getTime(), endDate.getTime());
    };

    const addEventListenerWithNullCheck = (
      id: string,
      callback: (e: Event) => void
    ) => {
      const el = document.querySelector(`#${id}`);
      if (el) {
        el.addEventListener("click", callback);
      }
    };

    addEventListenerWithNullCheck("one_month", (e: Event) => {
      resetCssClasses(e.target);
      zoomX(new Date("28 Jan 2013"), new Date("27 Feb 2013"));
    });

    addEventListenerWithNullCheck("six_months", (e: Event) => {
      resetCssClasses(e.target);
      zoomX(new Date("27 Sep 2012"), new Date("27 Feb 2013"));
    });

    addEventListenerWithNullCheck("one_year", (e: Event) => {
      resetCssClasses(e.target);
      zoomX(new Date("27 Feb 2012"), new Date("27 Feb 2013"));
    });

    addEventListenerWithNullCheck("ytd", (e: Event) => {
      resetCssClasses(e.target);
      zoomX(new Date("01 Jan 2013"), new Date("27 Feb 2013"));
    });

    addEventListenerWithNullCheck("all", (e: Event) => {
      resetCssClasses(e.target);
      zoomX(new Date("23 Jan 2012"), new Date("27 Feb 2013"));
    });

    return () => {
      if (chart) {
        chart.destroy();
      }
    };
  }, []);

  return <div id="chart-timeline" ref={chartRef}></div>;
};

export default DateTimeXAxis;
